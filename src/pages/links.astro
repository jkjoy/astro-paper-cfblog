---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getLinks } from '../lib/wp';

// 从 /wp-json/wp/v2/links 获取友链
const linksData = await getLinks();
const groups = linksData.reduce((acc, l) => {
  const key = l.category?.name ?? '链接';
  (acc[key] ??= []).push(l);
  return acc;
}, {} as Record<string, typeof linksData>);
const catNames = Object.keys(groups);

// 静态备用列表（当远端未提供 links 时显示）
const fallbackLinks = [
  { name: 'Cloudflare Pages', url: 'https://pages.cloudflare.com/', desc: '轻量快速的静态站点托管' },
  { name: 'WordPress REST API', url: 'https://developer.wordpress.org/rest-api/', desc: '内容数据来源' },
  { name: 'Astro', url: 'https://astro.build/', desc: '站点框架' },
];
---

<BaseLayout title="链接" description="友链与资源">

  {linksData.length > 0 ? (
    catNames.map((name) => (
      <section class="relative my-10 first-of-type:mt-0 last-of-type:mb-0">
        <h2 class="mb-14">{name}</h2>
        {groups[name].map((l) => (
          <section class="relative my-10 first-of-type:mt-0 last-of-type:mb-0 flex items-center">
            {l.avatar ? (
              <img
                class="h-7 w-7 rounded-full border-[0.5px] border-black/10 bg-white/50 ltr:mr-3 rtl:ml-3 dark:bg-white/90!"
                src={l.avatar}
                alt={l.name}
              />
            ) : null}
            <div>
              <h3 class="my-0!">{l.name}</h3>
              {l.description && (
                <div class="text-xs antialiased opacity-60">{l.description}</div>
              )}
            </div>
            <a
              class="absolute inset-0 text-[0px]"
              href={l.url}
              target={l.target || '_blank'}
              rel="noopener"
            >
              {l.name}
            </a>
          </section>
        ))}
      </section>
    ))
  ) : (
    <section class="relative my-10 first-of-type:mt-0 last-of-type:mb-0">
      <h2 class="mb-14">Links</h2>
      {fallbackLinks.map((l) => (
        <section class="relative my-10 first-of-type:mt-0 last-of-type:mb-0">
          <h3 class="my-0!">{l.name}</h3>
          {l.desc && <div class="text-xs antialiased opacity-60">{l.desc}</div>}
          <a class="absolute inset-0 text-[0px]" href={l.url} target="_blank" rel="noopener">{l.name}</a>
        </section>
      ))}
    </section>
  )}
</BaseLayout>
